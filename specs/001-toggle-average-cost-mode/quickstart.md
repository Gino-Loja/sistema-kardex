# Quickstart: Toggle Average Cost Calculation Mode

This guide provides a high-level overview for developers to understand and start working on the "Toggle Average Cost Calculation Mode" feature.

## 1. Feature Overview

The goal is to add a toggle on the warehouse details page that allows a user to enable or disable automatic average cost calculations for that specific warehouse.

- **Spec**: `specs/001-toggle-average-cost-mode/spec.md`
- **Plan**: `specs/001-toggle-average-cost-mode/plan.md`

## 2. Key Components

### Database

1.  **Migration**: A new `boolean` column `auto_update_average_cost` needs to be added to the `bodegas` table.
    -   **File**: A new migration file will be generated by Drizzle Kit.
    -   **Schema**: `src/lib/drizzle/schemas/bodegas.ts` must be updated first.
    -   **Default**: The default value should be `false` (Manual mode).

### Backend

2.  **API Endpoint**: A `PATCH` endpoint is required to update the new flag.
    -   **Location**: `src/app/api/bodegas/[id]/route.ts`
    -   **Action**: It should handle a `PATCH` request to update the `auto_update_average_cost` field for a given warehouse ID.
    -   **Contract**: See `specs/001-toggle-average-cost-mode/contracts/openapi.yml`.

3.  **Conditional Logic**: The core business logic needs to be updated.
    -   **Location**: The service responsible for handling inbound movements (likely `src/lib/dal/services/movements.service.ts`).
    -   **Action**: Before calculating the new average cost, this service must first retrieve the `auto_update_average_cost` setting for the relevant warehouse. The calculation should only run if the flag is `true`.

### Frontend

4.  **UI Component**: A toggle/switch component needs to be added to the warehouse details page.
    -   **Location**: The page is likely located at `src/app/(dashboard)/warehouses/[id]/page.tsx` or a similar path.
    -   **Component**: Use a pre-existing `Switch` component from the project's UI library (e.g., Shadcn).
    -   **Action**: When toggled, this component should call the `PATCH /api/bodegas/[id]` endpoint (or use a Server Action). It should not show a success message but must show an error if the update fails.

## 3. Development Workflow

1.  **Update Schema**: Add the `auto_update_average_cost` field to `src/lib/drizzle/schemas/bodegas.ts`.
2.  **Generate Migration**: Run `drizzle-kit generate` to create the SQL migration file.
3.  **Apply Migration**: Run the migration against your local database.
4.  **Implement Backend**:
    -   Create or update the `PATCH` API endpoint.
    -   Add the conditional check to the movement service.
5.  **Implement Frontend**:
    -   Add the `Switch` component to the warehouse details page.
    -   Implement the client-side logic or Server Action to call the backend.
6.  **Write Tests**:
    -   Write a unit test for the movement service to verify the conditional logic.
    -   Write an integration test for the API endpoint.
    -   Write an end-to-end test for the UI interaction.
